---
import { Picture } from 'astro:assets';

import Tag, { type TagColour } from './Tag.astro';
import Text from './Text.astro';

import fallbackImage from '../assets/images/flow.png';

export type Props = {
  title: string;
  description: string;
  tags?: string[];
  tagColour: TagColour;
  projectNumber: number;
  href: string;
  image?: ImageMetadata;
};

const { title, tagColour, description, projectNumber, href, tags, image } =
  Astro.props;

const hoverImage = image ?? fallbackImage;
---

<div class="relative" data-project-tile-wrapper>
  <a
    data-project-tile
    class="flex w-full gap-x-[68px] border-2 px-[68px] py-4"
    href={href}
  >
    <div class="flex items-center">
      <Text type="h2">
        <span class="align-middle"> {projectNumber}. </span>
      </Text>
    </div>

    <div class="flex flex-col">
      <Text type="sh1" transition:name={`project-title-${title}`}>{title}</Text>

      <div class="flex gap-x-8 pt-2">
        {tags?.map((tag) => <Tag colour={tagColour}>{tag}</Tag>)}
      </div>
      <div class="pt-6">
        <Text type="body">
          {description}
        </Text>
      </div>
    </div>
  </a>

  <div
    data-hover-image
    class="pointer-events-none absolute top-0 right-0 z-40 hidden h-[440px] w-[640px] translate-x-1/4 border-2 bg-white p-20 opacity-0 transition-opacity duration-300 ease-in-out"
  >
    <Picture
      src={hoverImage}
      formats={['avif', 'webp']}
      alt={`Preview of ${title} project`}
    />
  </div>
</div>

<script>
  function setupHoverTooltips() {
    const wrappers = document.querySelectorAll('[data-project-tile-wrapper]');

    wrappers.forEach((wrapper) => {
      const tile = wrapper.querySelector('[data-project-tile]');
      const tooltip = wrapper.querySelector<HTMLElement>('[data-hover-image]');

      if (!tile || !tooltip) return;

      tile.addEventListener('mouseenter', () => {
        tooltip.classList.remove('hidden');
        requestAnimationFrame(() => {
          tooltip.classList.add('opacity-100');
          tooltip.classList.remove('opacity-0');
        });
      });

      tile.addEventListener('mouseleave', () => {
        tooltip.classList.add('opacity-0');
        tooltip.classList.remove('opacity-100');
        tooltip.addEventListener(
          'transitionend',
          () => {
            if (tooltip.classList.contains('opacity-0')) {
              tooltip.classList.add('hidden');
            }
          },
          { once: true },
        );
      });
    });
  }

  setupHoverTooltips();
  document.addEventListener('astro:page-load', setupHoverTooltips);
</script>
